---
title: "Atividade 2: Monitoramento de Frota de Ônibus"
date: 2025-11-23
execute:
    enable: true
---

## Objetivo

Criar um mapa interativo que mostre as paradas de uma linha de ônibus e as posições em tempo real dos veículos dessa linha, utilizando diferentes cores para diferenciar paradas e posições reais.

## Implementação

A solução foi desenvolvida utilizando:

- **API Olho Vivo da SPTrans**: Para obter dados de paradas e posições em tempo real
- **Folium**: Biblioteca Python para criação de mapas interativos
- **Requests**: Para fazer requisições HTTP à API

### Funcionamento

A função `criar_mapa_monitoramento()` realiza os seguintes passos:

1. **Autenticação**: Autentica na API Olho Vivo usando um token
2. **Busca de paradas**: Obtém todas as paradas da linha especificada
3. **Busca de posições**: Obtém as posições em tempo real dos ônibus da linha
4. **Criação do mapa**: Gera um mapa com marcadores diferenciados por cor

### Código Principal

```python
import os
import requests
from folium import Map, Marker, Icon
from dotenv import load_dotenv

def criar_mapa_monitoramento(codigo_linha):
    # Carrega o token do arquivo .env (segurança)
    load_dotenv(".env")
    s = requests.Session()
    
    # Autentica na API
    token = os.getenv('SPTRANS_TOKEN')
    res_auth = s.post(
        f"http://api.olhovivo.sptrans.com.br/v2.1/Login/Autenticar?token={token}"
    )
    
    # Busca paradas da linha
    res_paradas = s.get(
        f"http://api.olhovivo.sptrans.com.br/v2.1/Parada/BuscarParadasPorLinha?codigoLinha={codigo_linha}"
    )
    paradas = res_paradas.json()
    
    # Busca posições em tempo real
    res_posicoes = s.get(
        f"http://api.olhovivo.sptrans.com.br/v2.1/Posicao/Linha?codigoLinha={codigo_linha}"
    )
    posicoes = res_posicoes.json()
    veiculos = posicoes.get("vs", []) if posicoes else []
    
    # Cria o mapa centrado na primeira parada
    mapa = Map(
        location=[paradas[0]["py"], paradas[0]["px"]],
        zoom_start=14
    )
    
    # Adiciona marcadores azuis para paradas
    for parada in paradas:
        Marker(
            location=[parada["py"], parada["px"]],
            popup=f"Parada: {parada.get('np', 'Sem nome')}",
            icon=Icon(color='blue', icon='info-sign', prefix='glyphicon')
        ).add_to(mapa)
    
    # Adiciona marcadores vermelhos para posições em tempo real
    for veiculo in veiculos:
        Marker(
            location=[veiculo["py"], veiculo["px"]],
            popup=f"Ônibus: {veiculo.get('p', 'N/A')}",
            icon=Icon(color='red', icon='bus', prefix='fa')
        ).add_to(mapa)
    
    return mapa
```

### Diferenciação Visual

- **Pins Azuis**: Representam as paradas fixas da linha
- **Pins Vermelhos**: Representam as posições em tempo real dos ônibus em movimento

### Segurança

O token da API é armazenado em um arquivo `.env` que não é versionado no Git, garantindo a segurança das credenciais:

```python
# Arquivo .env (não versionado)
SPTRANS_TOKEN=seu_token_aqui
```

## Exemplo de Uso

```python
# Substitua pelo código da sua linha de ônibus
codigo_linha = "1892"
mapa = criar_mapa_monitoramento(codigo_linha)
mapa.show_in_browser()
```

## Execução (gerar mapa)

O bloco abaixo cria o mapa para a linha `1892`, salva como `map_1892.html` e mostra o link para visualização.

```{python}
from atividade2_monitoramento_onibus import criar_mapa

# Código da linha que deseja testar
codigo = "1892"

# Cria o mapa sem abrir automaticamente o navegador
m = criar_mapa(codigo, save_html=False)
outfile = f"map_{codigo}.html"
m.save(outfile)
print(f"Mapa gerado: {outfile}")

# Exibir um link simples para abrir manualmente
print(f"Abra o arquivo gerado no navegador: {outfile}")
```

## Resultado

O mapa gerado permite visualizar:

- **Todas as paradas** da linha de ônibus escolhida
- **Posições em tempo real** dos veículos em movimento
- **Informações detalhadas** ao clicar em cada marcador

## Considerações Técnicas

- **Autenticação**: A API Olho Vivo requer autenticação via token
- **Sessão HTTP**: Utiliza uma sessão para manter a autenticação entre requisições
- **Coordenadas**: As coordenadas são fornecidas em formato [latitude, longitude]
- **Atualização**: As posições são obtidas em tempo real a cada execução do script

## Obtenção do Token

Para obter o token da API Olho Vivo:

1. Acesse: https://www.sptrans.com.br/desenvolvedores/
2. Crie uma conta de desenvolvedor
3. Solicite o token de acesso
4. Salve o token no arquivo `.env` como `SPTRANS_TOKEN=seu_token`

