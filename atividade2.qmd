---
title: "Atividade 2: Monitoramento de Frota de Ônibus"
date: 2025-11-23
execute:
  enable: true
---

## Objetivo

Criar um mapa interativo que mostre as paradas de uma linha de ônibus e as posições em tempo real dos veículos dessa linha, utilizando diferentes cores para diferenciar paradas e posições reais.

## Implementação

A solução foi desenvolvida utilizando:

- **API Olho Vivo da SPTrans**
- **Folium**
- **Requests**
- **python-dotenv**

### Funcionamento

A função `criar_mapa()` realiza:

1. Autenticação  
2. Busca de paradas  
3. Busca de posições  
4. Criação do mapa  

## Mapa da linha 1892

<!-- Renderiza o mapa gerado em map_1892.html -->
<iframe src="map_1892.html" width="100%" height="600" style="border:none;"></iframe>

### Código Principal (explicativo)

```python
import os
import requests
from folium import Map, Marker, Icon
from dotenv import load_dotenv

def criar_mapa_monitoramento(codigo_linha):
    # Carrega o token do arquivo .env (segurança)
    load_dotenv(".env")
    s = requests.Session()
    
    # Autentica na API
    token = os.getenv('SPTRANS_TOKEN')
    res_auth = s.post(
        f"http://api.olhovivo.sptrans.com.br/v2.1/Login/Autenticar?token={token}"
    )
    
    # Busca paradas da linha
    res_paradas = s.get(
        f"http://api.olhovivo.sptrans.com.br/v2.1/Parada/BuscarParadasPorLinha?codigoLinha={codigo_linha}"
    )
    paradas = res_paradas.json()
    
    # Busca posições em tempo real
    res_posicoes = s.get(
        f"http://api.olhovivo.sptrans.com.br/v2.1/Posicao/Linha?codigoLinha={codigo_linha}"
    )
    posicoes = res_posicoes.json()
    veiculos = posicoes.get("vs", []) if posicoes else []
    
    # Cria o mapa centrado na primeira parada
    mapa = Map(
        location=[paradas[0]["py"], paradas[0]["px"]],
        zoom_start=14
    )
    
    # Adiciona marcadores azuis para paradas
    for parada in paradas:
        Marker(
            location=[parada["py"], parada["px"]],
            popup=f"Parada: {parada.get('np', 'Sem nome')}",
            icon=Icon(color='blue', icon='info-sign', prefix='glyphicon')
        ).add_to(mapa)
    
    # Adiciona marcadores vermelhos para posições em tempo real
    for veiculo in veiculos:
        Marker(
            location=[veiculo["py"], veiculo["px"]],
            popup=f"Ônibus: {veiculo.get('p', 'N/A')}",
            icon=Icon(color='red', icon='bus', prefix='fa')
        ).add_to(mapa)
    
    return mapa
