---
title: "Atividade 1: Cotação do Dólar por Período"
date: 2025-11-23
execute:
    enable: true
---

## Objetivo

Criar uma rotina que receba como parâmetro uma string no formato "MMYYYY" (mês e ano) e retorne um gráfico de linha com a cotação do dólar para todos os dias úteis daquele mês.

## Implementação

A solução foi desenvolvida em Python utilizando as seguintes bibliotecas:

- `requests`: Para fazer requisições à API do Banco Central
- `plotly`: Para criar gráficos interativos
- `datetime` e `calendar`: Para manipulação de datas

### Funcionamento

A função `cotacao_dolar_periodo()` realiza os seguintes passos:

1. **Conversão da data**: Recebe a string "MMYYYY" e converte para o primeiro e último dia do mês
2. **Consulta à API**: Para cada dia do mês, consulta a API do BCB (Banco Central do Brasil)
3. **Tratamento de feriados**: Se não houver cotação disponível (feriado ou fim de semana), busca a cotação do último dia útil anterior
4. **Geração do gráfico**: Cria um gráfico de linha interativo mostrando a evolução da cotação

### Código Principal

```python
import requests
import calendar
from datetime import datetime, timedelta
import plotly.graph_objects as go

def cotacao_dolar_periodo(mmyyyy):
    # Converte "MMYYYY" em datas inicial e final do mês
    first_date = datetime.strptime(mmyyyy, "%m%Y")
    ultimo_dia = calendar.monthrange(first_date.year, first_date.month)[1]
    last_date = first_date.replace(day=ultimo_dia)
    
    # Listas para armazenar datas e cotações
    datas = []
    cotacoes = []
    
    # Itera sobre cada dia do mês
    data_atual = first_date
    while data_atual <= last_date:
        data_formatada = data_atual.strftime("%m-%d-%Y")
        
        # Consulta a API do BCB
        url = f"https://olinda.bcb.gov.br/olinda/servico/PTAX/versao/v1/odata/CotacaoDolarPeriodo(dataInicial=@dataInicial,dataFinalCotacao=@dataFinalCotacao)?@dataInicial='{data_formatada}'&@dataFinalCotacao='{data_formatada}'&$format=json"
        
        response = requests.get(url)
        dados = response.json()
        
        if dados.get("value") and len(dados["value"]) > 0:
            cotacao = dados["value"][0]["cotacaoVenda"]
            datas.append(data_atual)
            cotacoes.append(cotacao)
        else:
            # Busca cotação do dia anterior (feriado/fim de semana)
            cotacao_anterior = buscar_cotacao_dia_anterior(data_atual)
            if cotacao_anterior:
                datas.append(data_atual)
                cotacoes.append(cotacao_anterior)
        
        data_atual += timedelta(days=1)
    
    # Cria o gráfico
    fig = go.Figure()
    fig.add_trace(go.Scatter(
        x=datas,
        y=cotacoes,
        mode='lines+markers',
        name='Cotação do Dólar',
        line=dict(color='#1f77b4', width=2)
    ))
    
    fig.update_layout(
        title=f'Cotação do Dólar - {first_date.strftime("%B/%Y")}',
        xaxis_title='Data',
        yaxis_title='Cotação (R$)',
        hovermode='x unified'
    )
    
    return fig
```

### Tratamento de Feriados e Finais de Semana

A função `buscar_cotacao_dia_anterior()` utiliza recursão para encontrar a última cotação disponível quando não há dados para o dia atual:

```python
def buscar_cotacao_dia_anterior(data):
    dia_anterior = data - timedelta(days=1)
    data_formatada = dia_anterior.strftime("%m-%d-%Y")
    
    url = f"https://olinda.bcb.gov.br/olinda/servico/PTAX/versao/v1/odata/CotacaoDolarPeriodo(dataInicial=@dataInicial,dataFinalCotacao=@dataFinalCotacao)?@dataInicial='{data_formatada}'&@dataFinalCotacao='{data_formatada}'&$format=json"
    
    response = requests.get(url)
    dados = response.json()
    
    if dados.get("value") and len(dados["value"]) > 0:
        return dados["value"][0]["cotacaoVenda"]
    else:
        # Continua buscando recursivamente
        return buscar_cotacao_dia_anterior(dia_anterior)
```

## Exemplo de Uso

```python
# Exemplo: agosto de 2021
grafico = cotacao_dolar_periodo("082021")
grafico.show()
```

## Execução (gerar saída)

O bloco abaixo gera o gráfico interativo e salva como `dolar_082021.html`.

```{python}
from atividade1_cotacao_dolar import cotacao_dolar_periodo

# Substitua pelo mês/ano desejado (MMYYYY)
mes = "082021"
fig = cotacao_dolar_periodo(mes)
outfile = f"dolar_{mes}.html"
# salva arquivo HTML interativo
fig.write_html(outfile)
print(f"Arquivo gerado: {outfile}")

# Retorna a figura para que o Quarto a incorpore na página (interactive)
fig
```

## Resultado

O gráfico gerado mostra a evolução da cotação do dólar ao longo do mês, permitindo visualizar tendências e variações diárias. O gráfico é interativo, permitindo zoom, pan e visualização de valores ao passar o mouse.

## Considerações Técnicas

- **API utilizada**: API PTAX do Banco Central do Brasil
- **Formato de data**: A API requer datas no formato "MM-DD-YYYY"
- **Tratamento de erros**: Implementado tratamento para casos onde não há cotação disponível
- **Performance**: A função itera sobre todos os dias do mês, fazendo uma requisição por dia

